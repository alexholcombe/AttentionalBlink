---
title: "compare MATLAB to R"
author: "Alex Holcombe"
date: "8/24/2017"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE,  comment = NA)
# http://htmlpreview.github.io/?https://github.com/alexholcombe/MixtureModelRSVP/blob/master/compareMATLABtoR.html
```

Import data

```{r importData, echo=FALSE}
rm(list=ls())

mixModelingPath<- file.path("mixtureModeling")

#Import MATLAB fits
MATLABmixtureModelOutputPath<-"~/Google\ Drive/Backwards\ paper/secondPaper/E1/Data/MixModData"
importedToRbyChris <- "allParams.RData"
MATLABmixtureModelOutput<- file.path( MATLABmixtureModelOutputPath, importedToRbyChris )
  
#Import raw data
rawDataPath<- file.path("data/")
#Experiment was administered by MATLAB
#.mat file been preprocessed into melted long dataframe by backwarsLtrsLoadRawData.R
data<- readRDS( file.path(rawDataPath, "alexImportBackwardsPaper2E1.Rdata") ) 

#tidy data
library(dplyr)
df<- data
#It seems that to work with dplyr, can't have array field like letterSeq
df$letterSeq<- NULL


numItemsInStream<- length( data$letterSeq[1,] )  
minSPE<- -17; maxSPE<- 17

df<-df %>% rename(stream = target, orientation = condition )
df <- df %>% mutate( stream =ifelse(stream==1, "Left","Right") )
#mutate condition to Orientation
df <- df %>% mutate( orientation =ifelse(orientation==1, "Canonical","Inverted") )

#Load in MATLAB parameter estimates from Chris Bush run of MATLAB
load(MATLABmixtureModelOutput, verbose=FALSE)
#join into single long dataframe
estimates_MATLAB<- merge(efficacy.long,latency.long)
estimates_MATLAB<- merge(estimates_MATLAB,precision.long)
estimates_MATLAB<- data.frame(estimates_MATLAB)
names(estimates_MATLAB) <- tolower(names(estimates_MATLAB)) #lower case the column names
estimates_MATLAB<-estimates_MATLAB %>%
              mutate(efficacy=efficacy/100,latency=latency/100,precision=precision/100)


```

```{r calcLikelihoodForMATLABparams, echo=FALSE}
  #Want to add likelihood for MATLAB estimates to dataframe. Then can plot it with ggplot
  dfM<-merge( df, estimates_MATLAB )
  #dfM<- dfM %>% 
   #       rename(efficacy = efficacy_M, latency= latency_M, precision = precision_M)
  condtnVariableNames <- c("subject","stream", "orientation") # 

  #Unfortunately need the actual data for exact calculation of likelihood,
  # because guessing distribution depends on targetSP for that particular condition
  #Calculate the likelihood of the data given the MATLAB estimates
  source( file.path(mixModelingPath,"likelihoodOneConditionGivenParams.R") ) #for calcFitDataframes

  dfMl<- dfM %>%    # dplyr::filter(subject=="AA") %>%
    group_by_(.dots = condtnVariableNames) %>%  #.dots needed when you use variable
    #do ( print(.) )
    do( likelihoodOneConditionForDplyr(.,numItemsInStream)   )
  #Calculated the likelihood for each condition.
  #Merge back with original dataframes.
  dfMl<- merge(dfM,dfMl)
  #Now need to reduce down, eliminating SPE so only one row per condition
  estimates_MATLAB <- unique( dfMl %>% select(stream,orientation,subject,efficacy,latency,precision,val) )
  #estimates_MATLAB<- merge(estimates_MATLAB, likEachCondtn)

```

Fit mixture model with R if not already available.
```{r, echo=FALSE, message=FALSE}
source( file.path(mixModelingPath,"analyzeOneCondition.R") )

if (!exists("estimates")) {
  estimates<- df %>%    #filter(subject=="AA") %>%
    group_by_(.dots = condtnVariableNames) %>%  #.dots needed when you have a variable containing multiple factor names
    do(analyzeOneCondition(.,numItemsInStream,parameterBounds()))
  estimates<- estimates %>% rename(efficacy = p1, latency = p2, precision = p3)
}
head(estimates)
```

Unfortunately the differences between MATLAB and R are not trivial. Not substantial either! but we'd prefer trivial.

```{r, echo=FALSE, message=FALSE}
#Compare MATLAB parameter estimates to R
estimates_MATLAB<- estimates_MATLAB %>% rename(efficacy_M = efficacy, latency_M = latency, precision_M = precision, val_M = val)
merged<- merge(estimates,estimates_MATLAB)  
merged<- merged %>% mutate( effDiff = efficacy-efficacy_M, latDiff= latency_M-latency, preDiff= precision_M-precision, negLogL_Diff = val - val_M ) 

#show differences columns only
diffs<- select(merged, ends_with("Diff"))
```

The mean discrepancy (mean of the absolute value of the difference of the parameter estimates) for
efficacy (effDiff), latency (latDiff), and precision (preDiff) is
```{r, echo=FALSE, message=FALSE}
#calc discrepancies
#Don't include negLogL because absolute value not interpretable
meanDiscrepancy<- diffs %>% select(-negLogL_Diff) 
meanDiscrepancy<- summarise_all(abs(meanDiscrepancy),mean)
round(meanDiscrepancy,3)
```

The bias difference (mean difference without taking the absolute value) is
```{r, echo=FALSE, message=FALSE}
biasDiff<- summarise_all(diffs,mean)
round(biasDiff,3)
```
Negative numbers above mean that MATLAB gives slightly higher efficacy and trivially higher precision.
For likelihood, smaller neg log likelihood is better.

Let's inspect histogram plots and fits to look for patterns.
```{r, echo=FALSE, message=FALSE, fig.height=30}
#create R curves
df<- df %>% dplyr::filter(subject <"AC")  #dplyr::filter(subject <="AP") #dplyr::filter(subject <= "BD" & subject >="AP")
source( file.path(mixModelingPath,"histogramPlotting.R") ) #for calcFitDataframes
# NEED TO CHANGE EVERYBODY TO VAL INSTEAD OF LIK

#Add R parameter estimates to dataframe
df<- merge(df,estimates) 

fitDfs<- df %>% group_by(orientation,stream,subject) %>% 
  do(calcFitDataframes(.,minSPE,maxSPE,numItemsInStream))

#create MATLAB curves
estimates_M<- estimates_MATLAB %>% rename(efficacy=efficacy_M,latency=latency_M,precision=precision_M)
#create temporary dataframe with data plus MATLAB estimates to generate curves
dM<-merge( select(df,-efficacy,-latency,-precision), estimates_M )
fitsMATLAB<- dM %>% group_by(orientation,stream,subject) %>% 
            do(calcFitDataframes(.,minSPE,maxSPE,numItemsInStream))

#Concatenate R and MATLAB into single dataframe
fitDfs$lang<-"R"; fitsMATLAB$lang<-"MATLAB"
fits_R_MATLAB <- rbind( data.frame(fitDfs), data.frame(fitsMATLAB) )
dfBoth<-rbind(   df %>% mutate(lang="R"), df %>% mutate(lang="MATLAB")  )

g=ggplot(dfBoth, aes(x=SPE)) + facet_grid(subject+stream+orientation~lang)
g<-g+geom_histogram(binwidth=1,color="grey90") + xlim(minSPE,maxSPE)
g<-g +theme_bw() +theme(panel.grid.minor=element_blank(),panel.grid.major=element_blank())# hide all gridlines.
g<-g+ theme(line=element_blank(), panel.border = element_blank())
sz=.8
g<-g+ geom_point(data=fits_R_MATLAB,aes(x=x,y=combinedFitFreq),color="chartreuse3",size=sz*2.5)
g<-g+ geom_line(data=fits_R_MATLAB,aes(x=x,y=guessingFreq),color="yellow",size=sz)
g<-g+ geom_line(data=fits_R_MATLAB,aes(x=x,y=gaussianFreq),color="lightblue",size=sz)
numGroups<- length(table(dfBoth$orientation,dfBoth$subject,dfBoth$stream,dfBoth$lang))
fontSz = 80/numGroups
g<-g + geom_text(data=fits_R_MATLAB,aes(x=-7,y=32, label = paste("plain(e)==", round(efficacy,2), sep = "")),  parse = TRUE,size=fontSz) +
  geom_text(data=fits_R_MATLAB,aes(x=-7,y=27, label = paste("mu==", round(latency,2), sep = "")),  parse = TRUE,size=fontSz)+
  geom_text(data=fits_R_MATLAB,aes(x=-7,y=23, label = paste("sigma==", round(precision,2), sep = "")),  parse = TRUE,size=fontSz) +
  geom_text(data=fits_R_MATLAB,aes(x=-7,y=27, label = paste("l==", round(val,1), sep = "")),  parse = TRUE,size=fontSz)
show(g)
```

Next I need to calculate the likelihood of the data according to the R estimates versus MATLAB
